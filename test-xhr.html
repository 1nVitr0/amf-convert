<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="lib/util/typedarray.js"></script>
    <script src="build/jquery.js"></script>
    <script src="build/amf.js"></script>

    <script type="text/javascript">
        $(function(){
            if (!XMLHttpRequest.prototype.sendAsBinary) {
                XMLHttpRequest.prototype.sendAsBinary = function (sData) {
                    var nBytes = sData.length, ui8Data = new Uint8Array(nBytes);
                    for (var nIdx = 0; nIdx < nBytes; nIdx++) {
                        ui8Data[nIdx] = sData.charCodeAt(nIdx) & 0xff;
                    }
//             send as ArrayBufferView...:
                    this.send(ui8Data);
//             ...or as ArrayBuffer (legacy)...: this.send(ui8Data.buffer);
                };
            }

            var xhr = new XMLHttpRequest();
            xhr.open("POST", 'http://amf.dev/php/server.php', false);
            xhr.setRequestHeader("Content-Type", "application/x-amf");
            if(xhr.overrideMimeType)
            {
                xhr.overrideMimeType("application/x-amf; charset=x-user-defined");
            } else {
                xhr.setRequestHeader("Accept-Charset: x-user-defined");
            }
            xhr.responseType = "raw";

            var guy = {name: 'Danny'};
            var bro = {name: 'Brad'};
            var siblings = [guy, bro];
            guy.siblings = siblings;

            var tests = [
                // strings
                ['empty string', ''],
                ['ascii string', 'Hello World'],
                ['unicode string', 'i ❤ π'],
                // numbers
                ['zero', 0 ],
                ['integer in 1 byte u29 range', 0x7F ],
                ['integer in 2 byte u29 range', 0x00003FFF ],
                ['integer in 3 byte u29 range', 0x001FFFFF ],
                ['integer in 4 byte u29 range', 0x1FFFFFFF ],
                ['large integer', 4294967296 ],
                ['large negative integer', -4294967296 ],
                ['small negative integer', -1 ],
                ['medium negative integer', -199 ],
                ['medium negative integer', -1956 ],
                ['small floating point', 0.123456789 ],
                ['small negative floating point', -0.987654321 ],
                ['Number.MIN_VALUE', Number.MIN_VALUE ],
                ['Number.MAX_VALUE', Number.MAX_VALUE ],
                ['Number.POSITIVE_INFINITY', Number.POSITIVE_INFINITY ],
                ['Number.NEGATIVE_INFINITY', Number.NEGATIVE_INFINITY ],
                ['Number.NaN', Number.NaN],
                // other scalars
                ['Boolean false', false],
                ['Boolean true', true ],
                ['undefined', undefined ],
                ['null', null],
                // Arrays
                ['empty array', [] ],
                ['sparse array', [undefined, undefined, undefined, undefined, undefined, undefined] ],
                ['multi-dimensional array', [
                    [
                        [],
                        []
                    ],
                    []
                ] ],
                // special objects
                ['date object (epoch)', new Date(0) ],
                ['date object (now)', new Date() ],
                // plain objects
                ['empty object', {} ],
                ['keyed object', { foo: 'bar', 'foobar': 'baz' } ],
                ['circular object', guy ]
            ];

// 512k string
            var rand = '';
            for (var i = 0; i < 1024 * 512; i++) {
                rand += String.fromCharCode(65);
            }

            var bin = AMF.serialize(tests);
            var nBytes = bin.length, ui8Data = new Uint8Array(nBytes);
            for (var nIdx = 0; nIdx < nBytes; nIdx++) {
                ui8Data[nIdx] = bin.charCodeAt(nIdx) & 0xff;
            }
//             send as ArrayBufferView...:
//            this.send(ui8Data);

            $.ajaxSetup({
                contentType: 'application/x-amf',
                xhr: function() {
                    return xhr;
                },
                beforeSend: function(xhr) {
//                    xhr.setRequestHeader('Content-Transfer-Encoding',' binary');
//                    debugger;
                },
                url: 'http://amf.dev/php/server.php',
                type: 'POST'
            });

            $.ajax({data: ui8Data, dataType:'binary',
                processData: false
            });
//            xhr.sendAsBinary(bin);

            console.log(xhr);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    var deserialized = AMF.deserialize(xhr.response);
                    console.dir(deserialized);
                }
            };

//            xhr.send(bin);
        });
    </script>
</head>
<body>
</body>
</html>