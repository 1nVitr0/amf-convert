<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="lib/util/typedarray.js"></script>
    <script src="build/amf.js"></script>

    <script type="text/javascript">
        (function() {

            if(!XMLHttpRequest.prototype.sendAsBinary) {
                XMLHttpRequest.prototype.sendAsBinary = function(sData) {
                    var nBytes = sData.length, ui8Data = new Uint8Array(nBytes);
                    for(var nIdx = 0; nIdx < nBytes; nIdx++) {
                        ui8Data[nIdx] = sData.charCodeAt(nIdx) & 0xff;
                    }
//                    this.send(base64.fromByteArray(ui8Data));
                    this.send(ui8Data);
                };
            }

            var xhr = new XMLHttpRequest();
            xhr.open("POST", 'http://amf.dev/php/server.php', false);
            xhr.setRequestHeader("Content-Type", "application/x-amf");
            if(xhr.overrideMimeType) {
                xhr.overrideMimeType("application/x-amf; charset=x-user-defined");
            } else {
                xhr.setRequestHeader("Accept-Charset", "x-user-defined");
            }
            xhr.responseType = "raw";

            var bin = AMF.serialize(tests);

            xhr.onreadystatechange = function() {
                if(xhr.readyState == 4) {
//                    var b = base64.toByteArray(xhr.responseText);
//                    var s = '';
//                    for(var i = 0; i < b.length; i++) {
//                        var byte = b[i];
//                        s += String.fromCharCode(byte);
//                    }

//                    var a = AMF.deserialize(s);

                    /**
                     * We expect *null* and the *circular object* tests to fail
                     */
                    tape('integration test', function(t) {
                        t.plan(tests.length);

                        var a = AMF.deserialize(xhr.responseText);

                        for(var test in tests) {
                            var result = a[test];
                            var test = tests[test];

                            t.same(result[1], test[1]);
                        }
                    });
                }
            };

//            $.ajax({data: ui8Data, dataType:'binary',
//                processData: false
//            });
            xhr.sendAsBinary(bin);
        })();
    </script>
</head>
<body>
</body>
</html>